---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

Required packages
```{r}
library(lme4)
library(emmeans)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(car)
library(tidyr)
library(rstatix)
library(DHARMa)
```

1. Yearly variation in morph ratio (MR)
```{r}
plant<- read.csv("Morph ratio plant.csv")
plant <- plant %>%
  mutate(Year = factor(
    Year,
    levels = c("T22", "T24", "T25", "G24", "G25")
  ))

p<- ggplot(plant, aes(x = Ratio)) +
  geom_histogram(
    aes(y = after_stat(density)), 
    binwidth = 0.15,
    fill = "white",
    colour = "black"
  ) +
  geom_density(linewidth = 0.8) + 
  labs(
    x = "Morph ratio (MR)",
    y = "Probability density"
  ) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 1, by = 0.25))+
  facet_wrap(~ Year, scales = "fixed")+
  theme(strip.placement = "outside")
p

Yearly_variation <- glmer(
  cbind(L, R) ~ Year + (1 | Population),
  data = plant,
  family = binomial
)

summary(Yearly_variation)

a<- Anova(Yearly_variation, type="III", test="Chisq")
print(a)
```

2. Statistical difference in number of inflorescences in three morph categories
```{r}
inflo <- read.csv("Morph ratio inflorescence.csv")

inflo <- inflo %>%
  mutate(Year = factor(
    Year,
    levels = c("T22", "T24", "T25", "G24", "G25")
  ))

p<- ggplot(inflo, aes(x = MR)) +
  geom_histogram(
    aes(y = after_stat(density)), 
    binwidth = 0.15,
    fill = "white",
    colour = "black"
  ) +
  geom_density(linewidth = 0.8) + 
  labs(
    x = "Morph ratio (MR)",
    y = "Probability density"
  ) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 1, by = 0.25))+
  facet_wrap(~ Year, scales = "fixed")
p

inflo <- inflo %>%
  mutate(
    morph_category = cut(
      MR,
      breaks = c(-0.001, 0.001, 0.45, 0.55, 0.99, 1.0),
      labels = c("Bias", "Mixed", "Iso", "Mixed", "Bias"),
      right = TRUE,
      include.lowest = TRUE))

inflo_count <- inflo %>%
  group_by(Individual_ID, morph_category) %>%
  summarise(count = n(), .groups = 'drop') %>% 
  ungroup() %>%
  complete(Individual_ID, morph_category, fill = list(count = 0))


inflo_count$Census <- c(
  rep("T22", 99),
  rep("T24", 90),
  rep("G24", 90),
  rep("T25", 90),
  rep("G25", 90)
)

df2 <- inflo_count %>% 
  group_by(morph_category) %>%
  summarise(mn = mean(count, na.rm = T),
            sd = sd(count, na.rm = T),
            se = sd/sqrt(n()))

model<- glmer.nb(count ~  morph_category + (1|Census), data = inflo_count)
summary(model)
a<- Anova(model, type="III", test="Chisq")
print(a)

emm_obj<- emmeans(model, pairwise ~ morph_category, adjust= "holm")
summary(emm_obj)
```
3. Comparison between total number of L and R morph flowers in a population level
```{r}
T22 <- c(71, 95)
res_T22 <- chisq.test(T22, p = c(1/2, 1/2))
res_T22

T24 <- c(113, 96)
res_T24 <- chisq.test(T24, p = c(1/2, 1/2))
res_T24

T25 <- c(125, 122)
res_T25 <- chisq.test(T25, p = c(1/2, 1/2))
res_T25

G24 <- c(67, 67)
res_G24 <- chisq.test(G24, p = c(1/2, 1/2))
res_G24

G25 <- c(108, 97)
res_G25 <- chisq.test(G25, p = c(1/2, 1/2))
res_G25
```
4. Compatibility between morphs
```{r}
df<- read.csv("Hand pollination.csv")
df2 <- df[-c(123:186, 228:247), ]

# Between treatments

mytable<- table(df2$Treatment, df2$Fruit)
mytable
test <- chisq.test(mytable)
test

pw<-mytable %>% pairwise_prop_test(Fruit~Treatment , p.adjust.method = "bonferroni")
print(pw)

#Between morphs

mytable<- table(df2$Morph, df2$Fruit)
mytable
test <- chisq.test(mytable)
test

#Between outcrossing and selfing treatments

mytable<- table(df2$Cross, df2$Fruit)
test <- chisq.test(mytable)
test

#Between inter morph and intra-morph treatments
mytable<- table(df2$Type, df2$Fruit)
test <- chisq.test(mytable)
test

treatments <- c("Inter-out", "Inter-geit", "Intra-out", 
                "Intra-geit")
success_rates <- c(80, 66.6, 60.9, 45) 
df <- data.frame(Treatment = treatments, SuccessRate = success_rates)
df$Treatment<- factor(df$Treatment,
                  levels = c ("Inter-out", "Inter-geit", "Intra-out", 
                              "Intra-geit"))
p<-ggplot(df, aes(x= Treatment, y= SuccessRate, fill= Treatment)) +
  geom_bar(stat= "identity", colour= "black", width = .9)+
  labs(y= "Success rate (%)", x= "Treatment type",
       fill = "Treatment")+
  scale_fill_grey()+ theme_classic()
p
```

5. Pollen placement on the pollinator
```{r}
df<- read.csv("Pollen placement.csv")
Pollen_placement <- glmer.nb(Count ~ Part+ Position * Morph + (1|Bee_ID),
                  data = df)
summary(Pollen_placement)

a<- Anova(Pollen_placement, type="III", test="Chisq")
print(a)

emm_obj<- emmeans(Pollen_placement, pairwise ~ Morph | Position, adjust="holm")
summary(emm_obj)

df2 <- df %>% 
  group_by(Position, Morph) %>%
  summarise(mn = mean(Count, na.rm = T),
            sd = sd(Count, na.rm = T),
            se = sd/sqrt(n()))
df2$Position<- factor(df2$Position,
                      levels = c ("L-Pro", "L-Dist", "R-Pro", "R-Dist"))

p <- ggplot(df2, aes(x=Position, y=mn, fill=Morph)) + 
  geom_bar(stat="identity", color="black",position=position_dodge()) +
  geom_errorbar(aes(ymin=mn-0, ymax=mn+se), width=.2,
                position=position_dodge(.9))+
  scale_fill_manual(values = c("black", "grey")) +
  labs(y= "Mean(Â± s.e.) number of labelled pollen grains", x= "Position on pollinator")+
  theme_classic()
p
```

6. Pollen movement
```{r}
df<- read.csv("Pollen movement.csv")
Pollen_movement<- glmer.nb(Count ~  Recipient* Donor +(1|Plot) + (1|Plant), data = df)
summary(Pollen_movement)

a<- Anova(Pollen_movement, type="III", test="Chisq")
print(a)

emm_obj<- emmeans(Pollen_movement, pairwise ~ Recipient * Donor, adjust= "holm")
summary(emm_obj)
```
7. Pollinator constancy
```{r}
df<- read.csv("Preference.csv")
t.test(df$Intra_switches, df$Inter_switches, paired = TRUE)
```
8. Pollinator movement within plant
```{r}
df<- read.csv("Pol switch.csv")

Pollinator_switch <- glmer(
  cbind(Inter_switches, Intra_switches) ~ MB + (1|Plant_ID) + (1|Population),
  data = df,
  family = binomial
)

summary(Pollinator_switch)

p<-ggplot(df, aes(x = MB, y = Prop_switches)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "black")+
  labs(y= "Frequency of inter-morph switches", x= "Morph ratio per individual")+
  theme_classic()
p
```

9. Effect of morph bias on natural fruitset
```{r}
df<-read.csv("Fruit set.csv")

Fruit_set <- glmer(
  cbind(Fruits, Bracts-Fruits) ~ MB +(1|Population),
  data = df,
  family = binomial
)

summary(Fruit_set)

p<-ggplot(df, aes(x = MB, y = df$Prop_fruits)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "black")+
  labs(y= "Natural fruit set (number of fruits/number of bracts)", x= "Morph bias of plants")+
  theme_classic()
p
```

